{% extends "base.html" %}

{% block title %}Dashboard | poro O sekho{% endblock %}

{% block style %}
<style>
.typing-dots {
  display: inline-block;
}
.typing-dots span {
  display: inline-block;
  width: 6px;
  height: 6px;
  margin: 0 2px;
  background: #555;
  border-radius: 50%;
  animation: blink 1.4s infinite ease-in-out both;
}
.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}
.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}
@keyframes blink {
  0%, 80%, 100% {
    transform: scale(0);
  }
  40% {
    transform: scale(1);
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2 class="mb-4">üëã Welcome back, {{ session.get('username') }}!</h2>
  <p class="lead text-muted">Your personalized learning dashboard at a glance.</p>

  <div class="row row-cols-1 row-cols-md-2 g-4 mt-4">
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üß† Custom Subjects</h5>
          <p class="card-text">Explore your added subjects or start a new one tailored to your interests.</p>
          <a href="{{ url_for('custom_subject.index') }}" class="btn btn-primary">Go to Subjects</a>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üêç Python Learning</h5>
          <p class="card-text">Practice Python coding, ask questions, and learn step by step with AI.</p>
          <a href="{{ url_for('python.index') }}" class="btn btn-success">Start Learning</a>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üìù Mock Tests</h5>
          <p class="card-text">Challenge yourself with mock tests and improve your skills.</p>
          <a href="{{ url_for('mocktest.index') }}" class="btn btn-warning">Take a Test</a>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üí¨ Ask AI Anything</h5>
          <p class="card-text">Get help instantly with our AI-powered assistant ‚Äî available 24/7.</p>
          <button class="btn btn-secondary" id="chat-anything-toggle">Open Chat</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Box -->
<div id="chatbox" class="card shadow-lg" style="display: none; position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); width: 90%; max-height: 95%; z-index: 999;">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <div><i class="bi bi-robot me-2"></i>AI Assistant</div>
    <button class="btn-close btn-close-white" id="chat-anything-close" aria-label="Close"></button>
  </div>

  <div class="card-body overflow-auto" id="chat-anything-messages" style="height: 300px; background-color: #f8f9fa;">
    <div class="text-muted small mb-2">üí¨ Ask me anything...</div>
  </div>

  <div class="card-footer bg-white border-top">
    <form id="chat-anything-form" class="d-flex align-items-center">
      <input type="text" id="chat-anything-input" class="form-control me-2" placeholder="Type your message..." required />
      <button type="submit" class="btn btn-outline-primary"><i class="bi bi-send"></i></button>
    </form>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
const chatToggle = document.getElementById('chat-anything-toggle');
const chatbox = document.getElementById('chatbox');
const chatClose = document.getElementById('chat-anything-close');
const chatForm = document.getElementById('chat-anything-form');
const chatInput = document.getElementById('chat-anything-input');
const chatMessages = document.getElementById('chat-anything-messages');

// Open chat
chatToggle.addEventListener('click', () => {
  chatbox.style.display = 'block';
  chatInput.focus();
});

// Close chat
chatClose.addEventListener('click', () => {
  chatbox.style.display = 'none';
});

// On submit
chatForm.addEventListener('submit', async function (e) {
  e.preventDefault();
  const userMsg = chatInput.value.trim();
  if (!userMsg) return;

  appendMessage('user', userMsg);
  chatInput.value = '';

  const typingEl = showTypingIndicator();

  try {
    const response = await fetch('/chat/anything', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: userMsg })
    });

    const data = await response.json();
    typingEl.remove();
    appendMessage('bot', data.response);
  } catch (error) {
    typingEl.remove();
    appendMessage('bot', '‚ö†Ô∏è Sorry, something went wrong.');
  }
});

function appendMessage(sender, text) {
  const wrapper = document.createElement('div');
  wrapper.className = sender === 'user'
    ? 'd-flex justify-content-end mb-2'
    : 'd-flex justify-content-start mb-2';

  const bubble = document.createElement('div');
  bubble.className = 'p-2 rounded shadow-sm';
  bubble.style.maxWidth = '75%';
  bubble.innerText = text;
  bubble.style.backgroundColor = sender === 'user' ? '#0d6efd' : '#e9ecef';
  bubble.style.color = sender === 'user' ? 'white' : 'black';

  wrapper.appendChild(bubble);
  chatMessages.appendChild(wrapper);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
  const container = document.getElementById('chat-anything-messages');
  const wrapper = document.createElement('div');
  wrapper.className = 'd-flex justify-content-start mb-2';
  wrapper.innerHTML = `
    <div class="p-2 rounded shadow-sm" style="background-color: #e9ecef; color: black; max-width: 75%;">
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>
  `;
  container.appendChild(wrapper);
  container.scrollTop = container.scrollHeight;
  return wrapper;
}
</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
