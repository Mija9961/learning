{% extends "base.html" %}

{% block title %}Document Q&A | LearnAnythingWithAI{% endblock %}

{% block link %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  body {
    background-color: #f8f9fa;
  }
  .chat-message {
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 10px;
  }
  .chat-user {
    background-color: #e9f5ff;
    border: 1px solid #b6e0fe;
  }
  .chat-bot {
    background-color: #f1f3f5;
    border: 1px solid #d6d8db;
  }
  .card {
    border-radius: 12px;
  }
  .table-responsive {
    overflow-x: auto;
  }

  .qa-section {
    display: none;
    margin-top: 2rem;
  }
  
  .chat-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }

  .loading-indicator {
    display: none;
    text-align: center;
    padding: 1rem;
  }

  .file-preview {
    max-height: 200px;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
      <div class="card shadow-sm rounded-4">
        <div class="card-body">
          <!-- Flash Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <h5 class="card-title text-primary fw-semibold fs-4">
            ðŸ“š Document Q&A Assistant
          </h5>
          
          <p class="card-text text-muted">
            Upload your documents and ask questions about their content. Our AI will help you understand and analyze the information.
          </p>

          <!-- Upload Form -->
          <form id="uploadForm" method="POST" enctype="multipart/form-data" class="mb-4">
            <div class="mb-3">
              <label class="form-label">Upload Document (PDF, TXT, DOCX)</label>
              <input type="file" class="form-control" name="document" 
                     accept=".pdf,.txt,.docx" required>
              <div class="form-text">Maximum file size: 10MB</div>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-cloud-upload"></i> Upload Document
            </button>
          </form>

          <!-- Documents Table -->
          {% if documents %}
          <div class="table-responsive mt-4">
            <h5 class="mb-3">Your Documents</h5>
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Document</th>
                  <th>Uploaded Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for doc in documents %}
                <tr>
                  <td>{{ doc.filename }}</td>
                  <td>{{ doc.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button class="btn btn-sm btn-primary start-qa" 
                            data-doc-id="{{ doc.id }}">
                      <i class="bi bi-chat-dots"></i> Start Q&A
                    </button>
                    <a href="{{ url_for('rag.preview_document', doc_id=doc.document_id) }}" 
                       class="btn btn-sm btn-outline-secondary" target="_blank">
                      <i class="bi bi-eye"></i> Preview
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          <!-- Q&A Section -->
          <div id="qaSection" class="qa-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Ask Questions About Your Document</h5>
              <div class="btn-group">
                  <button id="downloadTxt" class="btn btn-outline-primary btn-sm" disabled>
                      <i class="bi bi-file-text"></i> Download TXT
                  </button>
                  <button id="downloadPdf" class="btn btn-outline-danger btn-sm" disabled>
                      <i class="bi bi-file-pdf"></i> Download PDF
                  </button>
              </div>
            </div>
            <div id="chatContainer" class="chat-container mb-3"></div>
            
            <form id="questionForm" class="mt-3">
              <div class="input-group">
                <input type="text" id="questionInput" class="form-control" 
                       placeholder="Type your question here...">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i> Ask
                </button>
              </div>
            </form>

            <div id="loadingIndicator" class="loading-indicator">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Processing your question...</p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let activeDocId = null;
    let qaHistory = [];  // Store Q&A history

    // Download as PDF
    document.getElementById('downloadPdf').addEventListener('click', function() {
        if (qaHistory.length === 0) return;

        const docElement = document.querySelector(`[data-doc-id="${activeDocId}"]`)
            .closest('tr')
            .querySelector('td:first-child');
        const documentName = docElement.textContent.trim();
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text(`Q&A History for: ${documentName}`, 14, 15);
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 25);
        
        // Prepare data: Q1 â†’ A1 â†’ Q2 â†’ A2
        const tableData = [];
        qaHistory.forEach((qa, index) => {
            tableData.push([`Q${index + 1}:`, qa.question]);
            tableData.push([`A${index + 1}:`, qa.answer]);
        });
        
        doc.autoTable({
            startY: 35,
            head: [['Type', 'Content']],
            body: tableData,
            theme: 'grid',
            styles: { fontSize: 10, cellPadding: 5 },
            columnStyles: { 0: { cellWidth: 15 }, 1: { cellWidth: 'auto' } },
            headStyles: { fillColor: [41, 128, 185], textColor: 255 },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });
        
        doc.save(`qa_history_${documentName.replace(/\.[^/.]+$/, '')}_${new Date().toISOString().slice(0,10)}.pdf`);
    });

    // Download as TXT
    document.getElementById('downloadTxt').addEventListener('click', function() {
        if (qaHistory.length === 0) return;

        const docElement = document.querySelector(`[data-doc-id="${activeDocId}"]`)
            .closest('tr')
            .querySelector('td:first-child');
        const documentName = docElement.textContent.trim();

        let content = `Q&A History for: ${documentName}\nDate: ${new Date().toLocaleString()}\n\n`;
        qaHistory.forEach((qa, index) => {
            content += `Q${index + 1}: ${qa.question}\n`;
            content += `A${index + 1}: ${qa.answer}\n\n`;
        });

        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qa_history_${documentName.replace(/\.[^/.]+$/, '')}_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    // Enable/disable buttons
    function updateDownloadButtons(enabled) {
        document.getElementById('downloadTxt').disabled = !enabled;
        document.getElementById('downloadPdf').disabled = !enabled;
    }

    // Start Q&A button
    document.querySelectorAll('.start-qa').forEach(button => {
        button.addEventListener('click', function() {
            activeDocId = this.dataset.docId;
            document.getElementById('qaSection').style.display = 'block';
            document.getElementById('chatContainer').innerHTML = '';
            qaHistory = [];
            updateDownloadButtons(false);
            document.getElementById('qaSection').scrollIntoView({ behavior: 'smooth' });
        });
    });

    // Question submission
    document.getElementById('questionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const question = document.getElementById('questionInput').value.trim();
        if (!question || !activeDocId) return;

        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'block';
        
        try {
            const response = await fetch('/rag/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ doc_id: activeDocId, question: question })
            });

            const data = await response.json();
            
            qaHistory.push({ question: question, answer: data.answer });
            updateDownloadButtons(true);
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML += `
                <div class="chat-message chat-user mb-2">
                    <strong>You:</strong> ${question}
                </div>
                <div class="chat-message chat-bot mb-3">
                    <strong>Assistant:</strong> ${data.answer}
                </div>
            `;

            document.getElementById('questionInput').value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while processing your question.');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
