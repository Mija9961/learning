{% extends "base.html" %}

{% block title %}Select Interview Topic | learnAnythingWithAI{% endblock %}

{% block link %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background-color: #f8f9fa;
  }
  .chat-message {
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 10px;
  }
  .chat-user {
    background-color: #e9f5ff;
    border: 1px solid #b6e0fe;
  }
  .chat-bot {
    background-color: #f1f3f5;
    border: 1px solid #d6d8db;
  }
  .card {
    border-radius: 12px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
   {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2 class="mb-4 text-primary">üë®‚Äçüíª {{ subject }} Mock Interview Assistant</h2>

  <!-- Conversation Selector -->
  <form method="get" action="{{ url_for('custom_subject.interview', subject_id=subject_id) }}" class="mb-4">
    <label for="conversation_id" class="form-label fw-semibold">Continue Previous Conversation:</label>
    <div class="input-group">
      <select name="conversation_id" id="conversation_id" class="form-select">
        <option value="">üÜï Start New Conversation</option>
        {% for conv_id, conv_name, ts in conversation_summaries %}
          <option value="{{ conv_id }}" {% if conversation_id == conv_id %}selected{% endif %}>
            {{ conv_name or "Untitled" }} ‚Äî {{ ts.strftime('%b %d, %Y %I:%M %p') }}
          </option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-primary">Open</button>
    </div>
  </form>

  <!-- Conversation List -->
  {% if conversation_summaries %}
  <h5 class="mt-4 mb-3 text-secondary">üóÇ All Sessions</h5>
  <ul class="list-group mb-5">
  {% for conv_id, conv_name, ts in conversation_summaries %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <a href="{{ url_for('custom_subject.interview', subject=subject, subject_id=subject_id, conversation_id=conv_id) }}" class="text-decoration-none fw-bold text-primary">
          {{ conv_name or "Untitled" }}
        </a>
        <small class="text-muted d-block">{{ ts.strftime('%b %d, %Y %I:%M %p') }} UTC</small>
        {% if conversation_id == conv_id %}
          <span class="badge bg-primary">Current</span>
        {% endif %}
      </div>
      <div class="btn-group">
        <form method="post" action="{{ url_for('custom_subject.delete_conversation_interview', subject=subject, subject_id=subject_id, conversation_id=conv_id) }}"
              onsubmit="return confirm('Are you sure you want to delete this conversation?');">
          {{ csrf_token() if csrf_token is defined }}
          <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
        <button type="button" class="btn btn-sm btn-outline-secondary ms-2"
                data-bs-toggle="modal"
                data-bs-target="#renameModal"
                data-convid="{{ conv_id }}"
                data-name="{{ conv_name or 'Untitled' }}">
          Rename
        </button>
      </div>
    </li>
  {% endfor %}
  </ul>

  {% endif %}

</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('custom_subject.rename_conversation_interview', subject=subject, subject_id=subject_id) }}">
      {{ csrf_token() if csrf_token is defined }}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="renameModalLabel">Rename Conversation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="conversation_id" id="renameConvId">
          <div class="mb-3">
            <label for="new_name" class="form-label">New Name</label>
            <input type="text" class="form-control" name="new_name" id="newConvName" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Rename</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const renameModal = document.getElementById('renameModal');
  renameModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const convId = button.getAttribute('data-convid');
    const convName = button.getAttribute('data-name');

    document.getElementById('renameConvId').value = convId;
    document.getElementById('newConvName').value = convName;
  });
</script>
{% endblock %}
