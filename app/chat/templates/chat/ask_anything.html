{% extends "base.html" %}

{% block title %}Dashboard | poro O sekho{% endblock %}

{% block link %}
  <!-- Include Bootstrap 5 & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}

{% block content %}
<div class="container py-5">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}



<!-- Chat Box -->
<div id="chatbox" class="card shadow-lg">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <div><i class="bi bi-robot me-2"></i>AI Assistant</div>
    <button class="btn-close btn-close-white" id="chat-anything-close" aria-label="Close"></button>
  </div>

  <div class="card-body overflow-auto" id="chat-anything-messages" style="height: 300px; background-color: #f8f9fa;">
    <div class="text-muted small mb-2">ðŸ’¬ Ask me anything about your tasks or project.</div>
  </div>

  <div class="card-footer bg-white border-top">
    <form id="chat-anything-form" class="d-flex align-items-center">
      <input type="text" id="chat-anything-input" class="form-control me-2" placeholder="Type your message..." required />
      <button type="submit" class="btn btn-outline-primary"><i class="bi bi-send"></i></button>
    </form>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  const chatToggle = document.getElementById('chat-anything-toggle');
  const chatbox = document.getElementById('chatbox');
  const chatClose = document.getElementById('chat-anything-close');
  const chatForm = document.getElementById('chat-anything-form');
  const chatInput = document.getElementById('chat-anything-input');
  const chatMessages = document.getElementById('chat-anything-messages');

  // Open/close toggle
  chatToggle.addEventListener('click', () => chatbox.style.display = 'block');
  chatClose.addEventListener('click', () => chatbox.style.display = 'none');

  // Handle form submit
  chatForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const userMsg = chatInput.value.trim();
    if (!userMsg) return;

    appendMessage('user', userMsg);
    chatInput.value = '';

    // Simulate bot typing...
    appendMessage('bot', '...');
    await new Promise(r => setTimeout(r, 800)); // Fake delay

    // Replace this fetch with actual Flask endpoint
    const response = await fetch('/chat/anything', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: userMsg })
    });

    const data = await response.json();
    chatMessages.lastElementChild.remove(); // Remove '...'
    responseMsg = data.response;
    appendMessage('bot', responseMsg);
  });

  function appendMessage(sender, text) {
    const wrapper = document.createElement('div');
    wrapper.className = sender === 'user'
      ? 'd-flex justify-content-end mb-2'
      : 'd-flex justify-content-start mb-2';

    const bubble = document.createElement('div');
    bubble.className = 'p-2 rounded shadow-sm';
    bubble.style.maxWidth = '75%';
    bubble.innerText = text;
    bubble.style.backgroundColor = sender === 'user' ? '#0d6efd' : '#e9ecef';
    bubble.style.color = sender === 'user' ? 'white' : 'black';

    wrapper.appendChild(bubble);
    chatMessages.appendChild(wrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
</script>


{% endblock %}
